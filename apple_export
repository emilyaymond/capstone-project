import xml.etree.ElementTree as ET
import matplotlib.pyplot as plt
from datetime import datetime
#https://medium.com/internet-of-technology/how-to-extract-and-analyze-apple-health-data-a-practical-python-guide-4b9ddbade37f
#uses that website as a guide

# Load and parse the XML file.
# (Optional): Load and parse the export_cda.xml file.
xml_path = "/Users/madelinedavis/Library/Mobile Documents/com~apple~CloudDocs/Desktop/apple_health_export 4/export.xml"
tree = ET.parse(xml_path)
root = tree.getroot()

# Create a set to store unique @type values.
types_set = set()

# Iterate through the XML elements and extract @type attribute.
for record in root.findall('.//Record'):
    type_attribute = record.get('type')
    if type_attribute:
        types_set.add(type_attribute)

# Print all unique @type values.
for type_value in types_set:
    print(type_value)

records = []

# for record in root.findall(".//Record[@type='HKQuantityTypeIdentifierBasalEnergyBurned']"):
#     records.append({
#         'start_date': record.get('startDate'),
#         'end_date': record.get('endDate'),
#         'value': record.get('value'),
#         'unit': record.get('unit'),
#     })

# print(records[:1])

heart_rate_records = []

for record in root.findall(".//Record[@type='HKQuantityTypeIdentifierHeartRate']"):
    value = record.get('value')
    start_date = record.get('startDate')

    # Convert the date string to a datetime object
    try:
        dt = datetime.strptime(start_date, "%Y-%m-%d %H:%M:%S %z")
    except ValueError:
        continue

    heart_rate_records.append({
        'datetime': dt,
        'heart_rate': float(value)
    })

# Sort records by time
heart_rate_records.sort(key=lambda x: x['datetime'])

# --- Plot the heart rate data ---
if heart_rate_records:
    dates = [r['datetime'] for r in heart_rate_records]
    values = [r['heart_rate'] for r in heart_rate_records]

    plt.figure(figsize=(12, 6))
    plt.plot(dates, values, color='red', linewidth=0.8)
    plt.title("Heart Rate Over Time (Apple Health Data)")
    plt.xlabel("Date")
    plt.ylabel("Heart Rate (BPM)")
    plt.grid(True, linestyle='--', alpha=0.6)
    plt.tight_layout()
    plt.show()
else:
    print("No heart rate data found.")      